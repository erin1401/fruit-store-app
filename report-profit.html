<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laba Rugi â€” Juragan Buah</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <img src="assets/logo.png" class="sidebar-logo">
    <div class="app-name">Juragan Buah</div>

    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Item Masuk</a>
    <a href="stock-out.html">Item Keluar</a>
    <a href="opname.html">Stok Opname</a>
    <a href="sales.html">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html">Laporan Persediaan</a>
    <a href="report-profit.html" class="active">Laba Rugi</a>
    <a href="users.html">User Management</a>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <h1>Laporan Laba Rugi</h1>
      <div id="userBox"></div>
    </div>

    <div class="container">

      <!-- FILTER -->
      <div class="card">
        <h3>Filter Tanggal</h3>

        <div class="grid-2">
          <div>
            <label>Dari</label>
            <input type="date" id="dateFrom" value="">
          </div>

          <div>
            <label>Sampai</label>
            <input type="date" id="dateTo" value="">
          </div>
        </div>

        <button class="btn" id="btnFilter" style="margin-top:12px;">Terapkan</button>
      </div>

      <!-- RESULT -->
      <div class="card">
        <h3>Ringkasan Laba Rugi</h3>

        <p>Total Penjualan: <strong>Rp <span id="sumSales">0</span></strong></p>
        <p>HPP (Total Modal): <strong>Rp <span id="sumHPP">0</span></strong></p>
        <p>Laba Kotor: <strong>Rp <span id="sumGross">0</span></strong></p>
        <p style="font-size:20px;margin-top:10px;">
          <strong>Laba Bersih: Rp <span id="sumNet">0</span></strong>
        </p>
      </div>

      <!-- DETAIL TRANSAKSI -->
      <div class="card">
        <h3>Detail Penjualan</h3>

        <table id="tblProfit">
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Total</th>
              <th>Modal</th>
              <th>Laba</th>
              <th style="width:120px">Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- MODAL -->
  <div id="globalModal" class="modal-bg">
    <div id="globalModalBox" class="modal-box"></div>
  </div>

  <!-- TOAST -->
  <div id="globalToast" class="toast"></div>

<script src="utils.js"></script>
<script src="data.js"></script>

<script>

checkLogin();
activateSidebarLinks();

// default tanggal hari ini
document.getElementById("dateFrom").value = today();
document.getElementById("dateTo").value = today();

document.getElementById("btnFilter").onclick = loadProfit;

function loadProfit() {

  const from = document.getElementById("dateFrom").value;
  const to = document.getElementById("dateTo").value;

  const sales = DataStore.getSales().filter(s => s.date >= from && s.date <= to);
  const items = DataStore.getItems();
  const stockIn = DataStore.getStockIn();

  let totalSales = 0;
  let totalModal = 0;

  const tbody = document.querySelector("#tblProfit tbody");
  tbody.innerHTML = "";

  sales.forEach(s => {
    totalSales += s.total;

    // hitung modal berdasarkan harga masuk
    let modal = 0;

    s.items.forEach(si => {
      let masukItem = stockIn.filter(m => m.itemId === si.id).sort((a, b) => b.date.localeCompare(a.date))[0];

      if (masukItem && masukItem.price) {
        modal += masukItem.price * si.qty;
      }
    });

    totalModal += modal;
    const laba = s.total - modal;

    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.date}</td>
      <td>Rp ${nf(s.total)}</td>
      <td>Rp ${nf(modal)}</td>
      <td>Rp ${nf(laba)}</td>
      <td>
        <button class="btn" onclick="detailProfit('${s.id}')">Detail</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  const gross = totalSales - totalModal;
  const net = gross; // jika tidak ada biaya lain

  document.getElementById("sumSales").innerText = nf(totalSales);
  document.getElementById("sumHPP").innerText = nf(totalModal);
  document.getElementById("sumGross").innerText = nf(gross);
  document.getElementById("sumNet").innerText = nf(net);
}

function detailProfit(id) {
  const sale = DataStore.getSales().find(x => x.id === id);
  const items = DataStore.getItems();
  const stockIn = DataStore.getStockIn();

  let rows = "";

  sale.items.forEach(si => {
    let item = items.find(i => i.id === si.id);

    let masuk = stockIn.filter(m => m.itemId === si.id)
      .sort((a, b) => b.date.localeCompare(a.date))[0];

    let modal = masuk ? masuk.price * si.qty : 0;
    let subtotal = si.qty * item.price;
    let laba = subtotal - modal;

    rows += `
      <tr>
        <td>${item.name}</td>
        <td>${si.qty}</td>
        <td>Rp ${nf(item.price)}</td>
        <td>Rp ${nf(subtotal)}</td>
        <td>Rp ${nf(modal)}</td>
        <td>Rp ${nf(laba)}</td>
      </tr>
    `;
  });

  openModal(`
    <h3>Detail Laba Rugi Transaksi</h3>

    <p>Tanggal: ${sale.date}</p>

    <table style="width:100%; margin-top:10px; border-collapse:collapse;">
      <tr>
        <th>Item</th>
        <th>Qty</th>
        <th>Harga Jual</th>
        <th>Subtotal</th>
        <th>Modal</th>
        <th>Laba</th>
      </tr>
      ${rows}
    </table>

    <div style="text-align:right;margin-top:12px;">
      <button class="btn btn-danger" onclick="closeModal()">Tutup</button>
    </div>
  `);
}

loadProfit();

window.detailProfit = detailProfit;

</script>

</body>
</html>
