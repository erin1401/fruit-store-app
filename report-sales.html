<!doctype html>
<html lang="id">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Laporan Penjualan â€” Juragan Buah</title><link rel="stylesheet" href="styles.css"></head>
<body>
  <div class="sidebar">
    <img src="assets/logo.png" alt="Juragan Buah" style="width:120px;display:block;margin:0 auto 10px">
    <div style="text-align:center;font-weight:700;margin-bottom:14px">Juragan Buah</div>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Barang Masuk</a>
    <a href="stock-out.html">Barang Keluar</a>
    <a href="opname.html">Stok Opname</a>
    <a href="sales.html">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html">Laporan Persediaan</a>
    <a href="report-profit.html">Laba Rugi</a>
    <hr style="border-color: rgba(255,255,255,0.06);margin-top:12px">
    <a href="users.html">Manajemen User</a>
  </div>

  <div class="main">
    <div class="topbar card" style="display:flex;justify-content:space-between;align-items:center"><h1 style="margin:0">Laporan Penjualan</h1><div id="userBox"></div></div>

    <div class="card" style="margin-top:14px;display:flex;gap:12px;align-items:flex-end">
      <div><label>Dari</label><input type="date" id="fromDate"></div>
      <div><label>Sampai</label><input type="date" id="toDate"></div>
      <div style="margin-left:auto"><button class="btn" id="btnExportSales">Export CSV</button></div>
    </div>

    <div class="card" style="margin-top:12px">
      <table id="rSalesTable"><thead><tr><th>Invoice</th><th>Tanggal</th><th>Pembeli</th><th>Total</th><th>Detail</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="globalModal" class="modal-bg"><div id="globalModalBox" class="modal-box"></div></div>
  <div id="globalToast" class="toast"></div>

  <script src="utils.js"></script>
  <script src="data.js"></script>
  <script>
    const session = loadJSON('sessionUser', null); if(!session) location.href='login.html';
    document.getElementById('userBox').innerText = `ðŸ‘¤ ${session.name||session.username} (${session.role})`;

    function renderReportSales(){
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      let sales = DataStore.getSales();
      if(from) sales = sales.filter(s => s.date >= from);
      if(to) sales = sales.filter(s => s.date <= to);
      const tbody = document.querySelector('#rSalesTable tbody'); tbody.innerHTML='';
      const buyers = DataStore.getBuyers();
      sales.forEach((s, idx)=>{
        const buyer = buyers.find(b=>b.id===s.buyerId);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.id}</td><td>${formatTanggal(s.date)}</td><td>${buyer?.name||'-'}</td><td>${formatRupiah(s.total)}</td><td><button class="btn" onclick="openSaleDetail('${s.id}')">Detail</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function openSaleDetail(id){
      const sale = DataStore.getSales().find(s=>s.id===id);
      openModal(`<h3>Detail Transaksi</h3><p>Invoice: ${sale.id}</p><table style="width:100%"><thead><tr><th>Nama</th><th>Qty</th><th>Harga</th></tr></thead><tbody>${sale.items.map(i=>`<tr><td>${i.name}</td><td>${i.qty}</td><td>${formatRupiah(i.price)}</td></tr>`).join('')}</tbody></table><div style="text-align:right;margin-top:10px"><button class="btn" onclick="closeModal()">Tutup</button></div>`);
    }

    document.getElementById('fromDate').addEventListener('change', renderReportSales);
    document.getElementById('toDate').addEventListener('change', renderReportSales);
    document.getElementById('btnExportSales').addEventListener('click', ()=>{
      const rows = DataStore.exportSalesCSVRows();
      exportCSV('sales.csv', rows);
      toast('Export CSV selesai');
    });

    renderReportSales();
  </script>
</body>
</html>
