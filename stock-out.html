<!doctype html>
<html lang="id">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Barang Keluar â€” Juragan Buah</title><link rel="stylesheet" href="styles.css"></head>
<body>
  <div class="sidebar">
    <img src="assets/logo.svg" style="width:100px;display:block;margin:6px auto">
    <div class="app-name">Juragan Buah</div>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Item Masuk</a>
    <a href="stock-out.html" class="active">Item Keluar</a>
    <a href="opname.html">Stok Opname</a>
    <a href="sales.html">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html">Laporan Persediaan</a>
    <a href="report-profit.html">Laba Rugi</a>
    <a href="users.html">User Management</a>
  </div>

  <div class="main">
    <div class="topbar"><h1>Item Keluar</h1><div id="userBox"></div></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <input id="searchStockOut" placeholder="Cari barang..." style="max-width:420px">
        <button class="btn" id="btnStockOut">+ Catat Keluar</button>
      </div>

      <table id="stockOutTable" style="margin-top:12px"><thead><tr><th>Tanggal</th><th>Item</th><th>Qty</th><th>Alasan</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="globalModal" class="modal-bg"><div id="globalModalBox" class="modal-box"></div></div>
  <div id="globalToast" class="toast"></div>

  <script src="utils.js"></script>
  <script src="data.js"></script>
  <script>
    checkLogin(); activateSidebarLinks();

    function renderStockOut(){
      const rows = DataStore.getStockOut().slice().reverse();
      const items = DataStore.getItems();
      const kw = (document.getElementById('searchStockOut').value||'').toLowerCase();
      const tbody = document.querySelector('#stockOutTable tbody'); tbody.innerHTML='';
      rows.filter(r => (items.find(i=>i.id===r.itemId)?.name||'').toLowerCase().includes(kw)).forEach(r=>{
        const item = items.find(i=>i.id===r.itemId);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${formatTanggal(r.date)}</td><td>${item?.name||'-'}</td><td>${r.qty}</td><td>${r.reason||''}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('btnStockOut').addEventListener('click', ()=>{
      const items = DataStore.getItems();
      openModal(`<h3>Catat Barang Keluar</h3><label>Pilih Item</label><select id="so_item">${items.map(i=>`<option value="${i.id}">${i.name} (Stok:${i.stock})</option>`).join('')}</select><label>Qty</label><input id="so_qty" type="number" value="1"><label>Alasan</label><input id="so_reason" type="text" placeholder="Rusak/Retur/Pemakaian"><div style="text-align:right;margin-top:12px"><button class="btn" id="saveStockOut">Simpan</button> <button class="btn btn-danger" onclick="closeModal()">Batal</button></div>`);
      setTimeout(()=> {
        document.getElementById('saveStockOut').onclick = ()=>{
          const itemId = document.getElementById('so_item').value;
          const qty = Number(document.getElementById('so_qty').value)||0;
          const reason = document.getElementById('so_reason').value.trim();
          if(qty<=0){ toast('Qty harus > 0','warn'); return; }
          DataStore.recordStockOut({ itemId, qty, reason });
          toast('Barang keluar dicatat');
          closeModal(); renderStockOut();
        };
      },60);
    });

    document.getElementById('searchStockOut').addEventListener('input', renderStockOut);
    renderStockOut();
  </script>
</body>
</html>
