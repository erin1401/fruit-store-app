<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stok Opname â€” Juragan Buah</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* small adjustments for opname layout */
    .opname-row { display:flex; gap:8px; align-items:center; }
    .opname-row > * { flex: 1; }
    .opname-row input[type="number"]{ width:100px; }
    @media(max-width:720px){
      .opname-row{flex-direction:column;align-items:stretch}
      .opname-row input[type="number"]{ width:100%; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <img src="assets/logo.png" style="width:100px;display:block;margin:6px auto">
    <div class="app-name">Juragan Buah</div>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Item Masuk</a>
    <a href="stock-out.html">Item Keluar</a>
    <a href="opname.html" class="active">Stok Opname</a>
    <a href="sales.html">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html">Laporan Persediaan</a>
    <a href="report-profit.html">Laba Rugi</a>
    <a href="users.html">User Management</a>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <h1>Stok Opname</h1>
      <div id="userBox"></div>
    </div>

    <div class="container">

      <div class="card" style="display:flex;gap:12px;align-items:center">
        <input id="searchOp" placeholder="Cari item..." style="flex:1" />
        <button class="btn" id="btnStartOpname">+ Input Opname</button>
        <button class="btn" id="btnHistory">Riwayat</button>
      </div>

      <div class="card" id="opnameCard">
        <h3>Input Stok Fisik (Cepat)</h3>

        <div id="opnameList"></div>

        <div style="text-align:right;margin-top:12px">
          <button class="btn" id="btnSaveOpname">Simpan Opname</button>
        </div>
      </div>

      <div class="card" id="historyCard" style="display:none;margin-top:14px">
        <h3>Riwayat Opname</h3>
        <table style="width:100%;" id="opnameHistoryTable">
          <thead><tr><th>Tanggal</th><th>Item</th><th>Sistem</th><th>Fisik</th><th>Selisih</th><th>Keterangan</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- MODAL & TOAST -->
  <div id="globalModal" class="modal-bg"><div id="globalModalBox" class="modal-box"></div></div>
  <div id="globalToast" class="toast"></div>

  <script src="utils.js"></script>
  <script src="data.js"></script>

  <script>
  // Guard + sidebar active
  checkLogin();
  activateSidebarLinks();

  // Helpers
  function todayISO(){
    return new Date().toISOString().slice(0,10);
  }
  function formatNum(n){ return Number(n || 0); }

  // Elements
  const search = document.getElementById('searchOp');
  const opnameListEl = document.getElementById('opnameList');
  const historyCard = document.getElementById('historyCard');
  const opnameCard = document.getElementById('opnameCard');

  // State for current opname entries { itemId, system, physical, reason }
  let opnameEntries = [];

  function buildOpnameInputs(){
    const items = DataStore.getItems();
    const kw = (search.value || '').toLowerCase();
    opnameListEl.innerHTML = '';

    if(items.length === 0){
      opnameListEl.innerHTML = '<div style="color:#666">Tidak ada item. Tambah item di Master Item.</div>';
      return;
    }

    items.filter(it => it.name.toLowerCase().includes(kw)).forEach(it => {
      // find existing entry
      const existing = opnameEntries.find(e => e.itemId === it.id);
      const physical = existing ? existing.physical : it.stock;

      const row = document.createElement('div');
      row.className = 'opname-row';
      row.innerHTML = `
        <div style="min-width:200px"><strong>${escapeHTML(it.name)}</strong><div style="font-size:12px;color:#666">Stok sistem: ${formatNum(it.stock)}</div></div>
        <div style="width:120px"><input type="number" min="0" class="phys" data-id="${it.id}" value="${physical}"></div>
        <div style="width:120px"><input type="text" class="reason" data-id="${it.id}" placeholder="Keterangan (opsional)" value="${existing?escapeHTML(existing.reason||''):''}"></div>
        <div style="width:80px;text-align:right"><span class="diff" data-id="${it.id}">${(physical - it.stock)}</span></div>
      `;
      opnameListEl.appendChild(row);

      // listeners
      const physInput = row.querySelector('.phys');
      const reasonInput = row.querySelector('.reason');
      const diffSpan = row.querySelector('.diff');

      physInput.addEventListener('input', () => {
        const val = Number(physInput.value || 0);
        diffSpan.innerText = val - it.stock;
        // update state
        const idx = opnameEntries.findIndex(e => e.itemId === it.id);
        if(idx >= 0){
          opnameEntries[idx].physical = val;
        } else {
          opnameEntries.push({ itemId: it.id, system: it.stock, physical: val, reason: reasonInput.value || '' });
        }
      });

      reasonInput.addEventListener('input', () => {
        const val = reasonInput.value || '';
        const idx = opnameEntries.findIndex(e => e.itemId === it.id);
        if(idx >=0){
          opnameEntries[idx].reason = val;
        } else {
          opnameEntries.push({ itemId: it.id, system: it.stock, physical: Number(physInput.value||0), reason: val });
        }
      });
    });
  }

  // Initial build
  buildOpnameInputs();

  // Search handler
  search.addEventListener('input', () => {
    buildOpnameInputs();
  });

  // Button: start opname (scroll to top of card and focus)
  document.getElementById('btnStartOpname').addEventListener('click', () => {
    opnameCard.scrollIntoView({ behavior: 'smooth' });
    const first = opnameListEl.querySelector('.phys');
    if(first) first.focus();
  });

  // Save opname - uses DataStore.recordStockOpname(entries)
  document.getElementById('btnSaveOpname').addEventListener('click', () => {
    // collect all inputs to ensure we have current values
    const physInputs = Array.from(opnameListEl.querySelectorAll('.phys'));
    opnameEntries = []; // rebuild from DOM
    physInputs.forEach(inp => {
      const id = inp.dataset.id;
      const val = Number(inp.value || 0);
      const reason = (opnameListEl.querySelector('.reason[data-id="'+id+'"]') || {}).value || '';
      opnameEntries.push({ itemId: id, physical: val, reason });
    });

    // filter only those that changed (physical != system)
    const changed = opnameEntries.filter(e => {
      const item = DataStore.getItems().find(i => i.id === e.itemId);
      return item && Number(item.stock) !== Number(e.physical);
    });

    if(changed.length === 0){
      toast('Tidak ada perubahan stok (tidak ada yang disimpan)', 'warn');
      return;
    }

    // call DataStore
    try {
      DataStore.recordStockOpname(changed);
      toast('Stok opname tersimpan');
      // rebuild inputs & history
      opnameEntries = [];
      buildOpnameInputs();
      renderHistory();
      // show history
      historyCard.style.display = 'block';
      historyCard.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      console.error(err);
      toast('Gagal menyimpan opname','error');
    }
  });

  // History rendering
  function renderHistory(){
    const hist = DataStore.getStockOpname().slice().reverse(); // latest first
    const tbody = document.querySelector('#opnameHistoryTable tbody');
    tbody.innerHTML = '';
    const items = DataStore.getItems();

    if(hist.length === 0){
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#666">Belum ada riwayat opname</td></tr>`;
      return;
    }

    hist.forEach(h => {
      const it = items.find(i => i.id === h.itemId) || { name: '(item dihapus)' };
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatTanggal(h.date || todayISO())}</td>
        <td>${escapeHTML(it.name)}</td>
        <td>${formatNum(h.system)}</td>
        <td>${formatNum(h.physical)}</td>
        <td>${formatNum(h.diff)}</td>
        <td>${escapeHTML(h.reason || '')}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // btnHistory toggles history visibility
  document.getElementById('btnHistory').addEventListener('click', () => {
    if(historyCard.style.display === 'none' || historyCard.style.display === '') {
      historyCard.style.display = 'block';
      renderHistory();
      historyCard.scrollIntoView({ behavior: 'smooth' });
    } else {
      historyCard.style.display = 'none';
    }
  });

  // utility escape
  function escapeHTML(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

  // initial history render
  renderHistory();

  </script>
</body>
</html>
