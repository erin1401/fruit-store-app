<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Persediaan â€” Juragan Buah</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <img src="assets/logo.png" class="sidebar-logo">
    <div class="app-name">Juragan Buah</div>

    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Item Masuk</a>
    <a href="stock-out.html">Item Keluar</a>
    <a href="opname.html">Stok Opname</a>
    <a href="sales.html">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html" class="active">Laporan Persediaan</a>
    <a href="report-profit.html">Laba Rugi</a>
    <a href="users.html">User Management</a>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <h1>Laporan Persediaan</h1>
      <div id="userBox"></div>
    </div>

    <div class="container">

      <!-- FILTER -->
      <div class="card">
        <h3>Filter Tanggal</h3>

        <div class="grid-2">
          <div>
            <label>Dari</label>
            <input type="date" id="dateFrom" value="">
          </div>

          <div>
            <label>Sampai</label>
            <input type="date" id="dateTo" value="">
          </div>
        </div>

        <button class="btn" id="btnFilter" style="margin-top:12px;">Terapkan</button>
      </div>

      <!-- RESULT TABLE -->
      <div class="card">
        <h3>Ringkasan Persediaan</h3>

        <table id="tblStock">
          <thead>
            <tr>
              <th>Item</th>
              <th>Stok Awal</th>
              <th>Masuk</th>
              <th>Keluar</th>
              <th>Opname</th>
              <th>Stok Akhir</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- MODAL -->
  <div id="globalModal" class="modal-bg">
    <div id="globalModalBox" class="modal-box"></div>
  </div>

  <!-- TOAST -->
  <div id="globalToast" class="toast"></div>

  <script src="utils.js"></script>
  <script src="data.js"></script>

<script>

checkLogin();
activateSidebarLinks();

// Set default tanggal
document.getElementById("dateFrom").value = today();
document.getElementById("dateTo").value = today();

document.getElementById("btnFilter").onclick = loadStock;

function loadStock() {
  const from = document.getElementById("dateFrom").value;
  const to = document.getElementById("dateTo").value;

  const items = DataStore.getItems();
  const stockIn = DataStore.getStockIn();
  const stockOut = DataStore.getStockOut();
  const opname = DataStore.getOpname();

  const tbody = document.querySelector("#tblStock tbody");
  tbody.innerHTML = "";

  items.forEach(item => {

    // MASUK (periode)
    const masuk = stockIn
      .filter(r => r.itemId === item.id && r.date >= from && r.date <= to)
      .reduce((a, b) => a + b.qty, 0);

    // KELUAR (periode)
    const keluar = stockOut
      .filter(r => r.itemId === item.id && r.date >= from && r.date <= to)
      .reduce((a, b) => a + b.qty, 0);

    // OPNAME (periode)
    const op = opname
      .filter(r => r.itemId === item.id && r.date >= from && r.date <= to)
      .sort((a, b) => b.date.localeCompare(a.date))[0];

    // STOK REAL-TIME
    const stokAkhir = DataStore.getStock(item.id);

    // STOK AWAL = stok akhir - masuk + keluar
    const stokAwal = stokAkhir - masuk + keluar;

    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${stokAwal}</td>
      <td>${masuk}</td>
      <td>${keluar}</td>
      <td>${op ? op.qty : '-'}</td>
      <td>${stokAkhir}</td>
    `;
    tbody.appendChild(tr);
  });
}

loadStock();

</script>

</body>
</html>
