<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Penjualan â€” Juragan Buah</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <img src="assets/logo.png" class="sidebar-logo">
    <div class="app-name">Juragan Buah</div>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Item Masuk</a>
    <a href="stock-out.html">Item Keluar</a>
    <a href="opname.html">Stok Opname</a>
    <a href="sales.html" class="active">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html">Laporan Persediaan</a>
    <a href="report-profit.html">Laba Rugi</a>
    <a href="users.html">User Management</a>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <h1>Penjualan</h1>
      <div id="userBox"></div>
    </div>

    <div class="container">

      <!-- SEARCH + BARCODE -->
      <div class="card">
        <label>Cari / Scan Barcode</label>
        <input id="scanInput" placeholder="Ketuk di sini lalu scan barcode..." autofocus>
      </div>

      <!-- ITEM LIST -->
      <div class="card">
        <h3>Daftar Item</h3>
        <table id="tblItems">
          <thead>
            <tr>
              <th>Nama</th>
              <th>Harga</th>
              <th>Stok</th>
              <th style="width:120px">Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- CART -->
      <div class="card">
        <h3>Keranjang</h3>
        <table id="tblCart">
          <thead>
            <tr>
              <th>Item</th>
              <th>Qty</th>
              <th>Subtotal</th>
              <th style="width:90px">Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div style="text-align:right;font-size:18px;margin-top:12px;">
          <strong>Total: Rp <span id="totalCart">0</span></strong>
        </div>
      </div>

      <!-- PAYMENT -->
      <div class="card">
        <h3>Pembayaran</h3>

        <label>Metode Pembayaran</label>
        <select id="payMethod">
          <option value="cash">TUNAI</option>
          <option value="transfer">TRANSFER</option>
        </select>

        <label>Jumlah Bayar</label>
        <input id="payAmount" type="number" placeholder="0">

        <label>Kembalian</label>
        <input id="payChange" type="text" disabled>

        <button class="btn" id="btnPay" style="margin-top:12px;width:100%;">
          Proses dan Cetak Struk
        </button>
      </div>

    </div>
  </div>

  <!-- MODAL -->
  <div id="globalModal" class="modal-bg">
    <div id="globalModalBox" class="modal-box"></div>
  </div>

  <!-- TOAST -->
  <div id="globalToast" class="toast"></div>

  <script src="utils.js"></script>
  <script src="data.js"></script>

  <script>

  checkLogin();
  activateSidebarLinks();

  let cart = [];

  function renderItems() {
    const items = DataStore.getItems();
    const tbody = document.querySelector("#tblItems tbody");
    tbody.innerHTML = "";

    items.forEach(i => {
      const stock = DataStore.getStock(i.id);

      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i.name}</td>
        <td>Rp ${nf(i.price)}</td>
        <td>${stock}</td>
        <td><button class="btn" onclick="addToCart('${i.id}')">Tambah</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function addToCart(itemId) {
    const items = DataStore.getItems();
    const item = items.find(x => x.id === itemId);
    const stock = DataStore.getStock(itemId);

    if (stock <= 0) {
      toast("Stok habis", "warn");
      return;
    }

    let c = cart.find(x => x.id === itemId);
    if (c) {
      if (c.qty + 1 > stock) {
        toast("Stok tidak cukup", "warn");
        return;
      }
      c.qty++;
    } else {
      cart.push({ id: itemId, qty: 1 });
    }

    renderCart();
  }

  function renderCart() {
    const items = DataStore.getItems();
    const tbody = document.querySelector("#tblCart tbody");
    tbody.innerHTML = "";
    let total = 0;

    cart.forEach(c => {
      const item = items.find(i => i.id === c.id);
      const subtotal = c.qty * item.price;
      total += subtotal;

      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.name}</td>
        <td><input type="number" value="${c.qty}" min="1" 
             onchange="updateQty('${c.id}', this.value)"></td>
        <td>Rp ${nf(subtotal)}</td>
        <td>
          <button class="btn btn-danger" onclick="removeCart('${c.id}')">Hapus</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("totalCart").innerText = nf(total);
  }

  function updateQty(id, q) {
    q = parseInt(q);
    const stock = DataStore.getStock(id);

    if (q <= 0 || q > stock) {
      toast("Qty tidak valid", "warn");
      renderCart();
      return;
    }

    let c = cart.find(x => x.id === id);
    c.qty = q;
    renderCart();
  }

  function removeCart(id) {
    cart = cart.filter(c => c.id !== id);
    renderCart();
  }

  // BARCODE SCAN (enter auto-add)
  const scanInput = document.getElementById("scanInput");
  scanInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      let code = scanInput.value.trim();
      scanInput.value = "";
      const items = DataStore.getItems();
      const item = items.find(i => i.barcode == code);

      if (!item) {
        toast("Barcode tidak ditemukan", "warn");
        return;
      }

      addToCart(item.id);
    }
  });

  // PAYMENT
  document.getElementById("payAmount").oninput = () => {
    const total = parseFloat(document.getElementById("totalCart").innerText.replace(/\./g, ""));
    const pay = parseFloat(document.getElementById("payAmount").value);
    let kembalian = pay - total;
    document.getElementById("payChange").value = kembalian >= 0 ? "Rp " + nf(kembalian) : "-";
  };

  // PAY + PRINT
  document.getElementById("btnPay").onclick = () => {

    if (cart.length === 0) {
      toast("Keranjang kosong", "warn");
      return;
    }

    const payMethod = document.getElementById("payMethod").value;
    const payAmount = parseFloat(document.getElementById("payAmount").value);
    const total = parseFloat(document.getElementById("totalCart").innerText.replace(/\./g, ""));

    if (!payAmount || payAmount < total) {
      toast("Pembayaran kurang", "warn");
      return;
    }

    // SIMPAN PENJUALAN
    const saleId = DataStore.addSale({
      items: cart,
      total,
      payAmount,
      method: payMethod,
      date: today()
    });

    // CETAK STRUK
    printReceipt(saleId);

    cart = [];
    renderCart();
    document.getElementById("payAmount").value = "";
    document.getElementById("payChange").value = "";
  };

  // PRINT RECEIPT
  function printReceipt(id) {
    const sale = DataStore.getSales().find(s => s.id === id);
    const items = DataStore.getItems();

    let rows = "";
    sale.items.forEach(s => {
      let item = items.find(i => i.id === s.id);
      rows += `
        <tr>
          <td>${item.name}</td>
          <td>${s.qty}</td>
          <td>Rp ${nf(item.price)}</td>
          <td>Rp ${nf(item.price * s.qty)}</td>
        </tr>`;
    });

    const win = window.open("", "_blank");
    win.document.write(`
      <html>
      <head>
        <title>Struk Penjualan</title>
        <style>
          body { font-family: Arial; padding:20px; }
          table { width:100%; border-collapse:collapse;margin-top:10px; }
          td,th { padding:8px; border-bottom:1px solid #ddd; }
        </style>
      </head>
      <body>
        <h2>Struk Penjualan</h2>
        <p>Tanggal: ${sale.date}</p>
        <p>Metode: ${sale.method.toUpperCase()}</p>

        <table>
          <tr>
            <th>Item</th>
            <th>Qty</th>
            <th>Harga</th>
            <th>Subtotal</th>
          </tr>
          ${rows}
        </table>

        <h3>Total: Rp ${nf(sale.total)}</h3>
        <h3>Bayar: Rp ${nf(sale.payAmount)}</h3>
        <h3>Kembalian: Rp ${nf(sale.payAmount - sale.total)}</h3>

        <script>
          window.print();
          setTimeout(() => window.close(), 300);
        <\/script>
      </body>
      </html>
    `);
  }

  renderItems();
  renderCart();

  window.addToCart = addToCart;
  window.updateQty = updateQty;
  window.removeCart = removeCart;

  </script>

</body>
</html>
