<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Penjualan â€” Juragan Buah</title>
  <link rel="stylesheet" href="styles.css">
  <!-- optional barcode library to generate barcode on receipt -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    /* small overrides for mobile POS layout */
    @media (max-width:700px){
      .pos-wrap{flex-direction:column;gap:14px}
      .pos-left, .pos-right{width:100%}
      .topbar .logo{display:none}
    }
    .pos-wrap{display:flex;gap:16px}
    .pos-left{flex:1}
    .pos-right{width:420px}
    .receipt{font-family: monospace; font-size:13px; }
    .receipt .line{border-bottom:1px dashed #ccc;margin:6px 0}
  </style>
</head>
<body class="fade-in">

  <div class="sidebar">
    <img src="assets/logo.png" alt="Juragan Buah" style="width:120px;display:block;margin:0 auto 10px">
    <div style="text-align:center;font-weight:700;margin-bottom:14px">Juragan Buah</div>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Barang Masuk</a>
    <a href="stock-out.html">Barang Keluar</a>
    <a href="opname.html">Stok Opname</a>
    <a href="sales.html" class="active">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html">Laporan Persediaan</a>
    <a href="report-profit.html">Laba Rugi</a>
  </div>

  <div class="main">
    <div class="topbar card" style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;align-items:center">
        <img src="assets/logo.png" class="logo" style="width:36px;height:36px;margin-right:8px">
        <div><h1 style="margin:0">Penjualan</h1><small id="page-subtitle">POS</small></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="toggleDark" class="dark-toggle">ðŸŒ™</button>
        <div id="userBox"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="pos-wrap">
        <div class="pos-left">
          <label>Pembeli (opsional)</label>
          <select id="saleBuyer"></select>

          <label>Barcode / Kode Produk</label>
          <input id="barcodeInput" placeholder="Scan atau ketik kode lalu enter">

          <div style="display:flex;gap:8px;align-items:end">
            <div style="flex:1">
              <label>Pilih Item</label>
              <select id="saleItem"></select>
            </div>
            <div style="width:100px">
              <label>Qty</label>
              <input id="saleQty" type="number" value="1">
            </div>
            <div style="align-self:flex-end">
              <button class="btn" id="btnAddCart">Tambah</button>
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" id="btnPay">Bayar</button>
            <button class="btn" id="btnClear">Bersihkan</button>
          </div>

        </div>

        <div class="pos-right">
          <h4>Keranjang</h4>
          <table id="cartTable"><thead><tr><th>Item</th><th>Harga</th><th>Qty</th><th>Subtotal</th><th></th></tr></thead><tbody></tbody></table>
          <div style="text-align:right;margin-top:8px">Total: <b id="cartTotal">Rp 0</b></div>

          <div style="margin-top:10px;display:flex;gap:8px;justify-content:space-between">
            <button class="btn" id="btnPrint" title="Cetak struk">Cetak Struk</button>
            <button class="btn btn-danger" id="btnSaveSale" title="Simpan transaksi">Simpan</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- global modal & toast & fab -->
  <div id="globalModal" class="modal-bg"><div id="globalModalBox" class="modal-box"></div></div>
  <div id="globalToast" class="toast"></div>
  <div id="globalFab" class="fab hidden">ï¼‹</div>

  <script src="utils.js"></script>
  <script src="data.js"></script>
  <script>
  // POS page logic
  const session = loadJSON('sessionUser', null);
  if(!session) {
    // optional: redirect to login
    // location.href = 'login.html';
    document.getElementById('userBox').innerText = 'Guest';
  } else {
    document.getElementById('userBox').innerText = `ðŸ‘¤ ${session.name || session.username} (${session.role})`;
  }

  let cart = [];

  function loadSaleDropdowns(){
    const items = DataStore.getItems();
    const buyers = DataStore.getBuyers();
    saleItem.innerHTML = items.map(i => `<option value="${i.id}" data-price="${i.price}" data-stock="${i.stock}" data-code="${i.code||''}">${i.name} (Stok:${i.stock})</option>`).join('');
    saleBuyer.innerHTML = `<option value="">- Umum -</option>` + buyers.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
  }

  function renderCart(){
    const tbody = document.querySelector('#cartTable tbody'); tbody.innerHTML = '';
    let total = 0;
    cart.forEach((c, idx) => {
      total += c.subtotal;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.name}</td><td>${formatRupiah(c.price)}</td><td>${c.qty}</td><td>${formatRupiah(c.subtotal)}</td><td><button class="btn btn-danger" onclick="removeCart(${idx})">Hapus</button></td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('cartTotal').innerText = formatRupiah(total);
  }

  function addToCartById(itemId, qty = 1){
    const it = DataStore.getItemById(itemId);
    if(!it){ toast('Item tidak ditemukan','error'); return; }
    if(qty > it.stock){ toast('Stok tidak mencukupi','error'); return; }
    const price = Number(it.price || 0);
    cart.push({ itemId: it.id, name: it.name, price, qty: Number(qty), subtotal: price * qty });
    renderCart();
  }

  document.getElementById('btnAddCart').addEventListener('click', ()=>{
    const id = document.getElementById('saleItem').value;
    const qty = Number(document.getElementById('saleQty').value) || 1;
    addToCartById(id, qty);
  });

  function removeCart(i){
    cart.splice(i,1); renderCart();
  }

  // barcode input handling (user can scan barcode, or type product code)
  document.getElementById('barcodeInput').addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
      const val = this.value.trim();
      if(!val) return;
      // try find item by code or id or name
      const items = DataStore.getItems();
      const found = items.find(it => (it.code && it.code.toString() === val) || it.id === val || it.name.toLowerCase() === val.toLowerCase());
      if(found){
        addToCartById(found.id, 1);
        this.value = '';
        this.focus();
      } else {
        toast('Produk tidak ditemukan','error');
      }
    }
  });

  // Save sale (without payment) or with payment
  document.getElementById('btnSaveSale').addEventListener('click', ()=> openPaymentModal(false));
  document.getElementById('btnPay').addEventListener('click', ()=> openPaymentModal(true));

  function openPaymentModal(goToPayment = true){
    if(cart.length === 0){ toast('Keranjang kosong','warn'); return; }

    const total = cart.reduce((s,x) => s + x.subtotal, 0);
    // Build modal: pilih metode (Cash / Transfer) dan input paid amount
    openModal(`
      <h3>Pembayaran</h3>
      <div>Total: <b>${formatRupiah(total)}</b></div>
      <label>Metode</label>
      <select id="pay_method">
        <option value="cash">Tunai</option>
        <option value="transfer">Transfer</option>
      </select>
      <label>Jumlah Dibayar</label>
      <input id="pay_paid" type="number" value="${total}">
      <div id="pay_info" style="margin-top:8px;color:#555"></div>
      <div style="text-align:right;margin-top:12px">
        <button class="btn" id="confirmPay">Simpan & Cetak</button>
        <button class="btn btn-danger" onclick="closeModal()">Batal</button>
      </div>
    `);

    // after modal open attach events
    setTimeout(() => {
      const pay_method = document.getElementById('pay_method');
      const pay_paid = document.getElementById('pay_paid');
      const pay_info = document.getElementById('pay_info');
      const updateInfo = ()=>{
        const paid = Number(pay_paid.value||0);
        if(pay_method.value === 'cash'){
          const change = paid - total;
          pay_info.innerText = change >= 0 ? `Kembalian: ${formatRupiah(change)}` : `Kurang: ${formatRupiah(Math.abs(change))}`;
        } else {
          pay_info.innerText = `Transfer: masukkan jumlah transfer. Bila dibayar lebih, sistem tidak auto kembalikan.`;
        }
      };
      pay_method.addEventListener('change', updateInfo);
      pay_paid.addEventListener('input', updateInfo);
      updateInfo();

      document.getElementById('confirmPay').addEventListener('click', ()=>{
        const method = pay_method.value;
        const paid = Number(pay_paid.value||0);
        const buyerId = document.getElementById('saleBuyer').value || null;
        // prepare items payload
        const itemsPayload = cart.map(c => ({ itemId: c.itemId, qty: c.qty, price: c.price }));
        try{
          const sale = DataStore.createSale({ buyerId, items: itemsPayload, cashier: (session && session.username) || 'kasir', payment: { method, paid }});
          toast('Transaksi tersimpan');
          closeModal();
          cart = []; renderCart();
          // print receipt
          printSaleReceipt(sale);
        }catch(err){
          toast(err.message || 'Gagal menyimpan','error');
        }
      }, { once:true });
    }, 120);
  }

  // Print functions
  document.getElementById('btnPrint').addEventListener('click', ()=>{
    // create a preview of current cart as receipt (not yet saved)
    if(cart.length === 0){ toast('Keranjang kosong'); return; }
    const total = cart.reduce((s,x)=>s + x.subtotal, 0);
    const html = renderReceiptHTML({ id: 'DRAFT', date: new Date().toISOString().slice(0,10), buyerName: '', items: cart, total });
    printReceiptHTML(html);
  });

  function printSaleReceipt(sale){
    // sale is object returned by DataStore.createSale
    const html = renderReceiptHTML(sale);
    printReceiptHTML(html);
  }

  function renderReceiptHTML(sale){
    const lines = [];
    lines.push(`<div style="text-align:center"><img src="assets/logo.png" style="width:140px"></div>`);
    lines.push(`<h3 style="text-align:center">Juragan Buah</h3>`);
    lines.push(`<div class="receipt">`);
    lines.push(`<div>Invoice: ${sale.id}</div>`);
    lines.push(`<div>Tanggal: ${formatTanggal(sale.date)}</div>`);
    if(sale.buyerName) lines.push(`<div>Pembeli: ${sale.buyerName}</div>`);
    lines.push(`<div class="line"></div>`);
    lines.push(`<table style="width:100%;font-family:monospace"><thead><tr><th style="text-align:left">Nama</th><th style="text-align:right">Qty</th><th style="text-align:right">Subtotal</th></tr></thead><tbody>`);
    sale.items.forEach(it => {
      lines.push(`<tr><td>${it.name}</td><td style="text-align:right">${it.qty}</td><td style="text-align:right">${formatRupiah(it.price * it.qty)}</td></tr>`);
    });
    lines.push(`</tbody></table>`);
    lines.push(`<div class="line"></div>`);
    lines.push(`<div style="text-align:right"><b>Total: ${formatRupiah(sale.total)}</b></div>`);
    if(sale.payment){
      lines.push(`<div>Pembayaran: ${sale.payment.method} - Dibayar: ${formatRupiah(sale.payment.paid||0)}</div>`);
      if(sale.payment.method === 'cash'){
        const change = (sale.payment.paid||0) - sale.total;
        lines.push(`<div>Kembalian: ${formatRupiah(Math.max(0, change))}</div>`);
      }
    }
    lines.push(`<div style="margin-top:12px;text-align:center">Terima kasih</div>`);
    lines.push(`</div>`);
    // optionally barcode
    lines.push(`<div style="text-align:center;margin-top:8px"><svg id="barcode"></svg></div>`);
    const html = lines.join('');
    // return HTML that includes script to render barcode
    return html + `<script>
      setTimeout(() => {
        try { JsBarcode("#barcode", "${sale.id}", { format: "CODE128", width:1, height:30, displayValue:true }); } catch(e){ console.warn(e); }
      }, 100);
    <\/script>`;
  }

  // clear cart
  document.getElementById('btnClear').addEventListener('click', ()=>{
    if(!confirm('Bersihkan keranjang?')) return;
    cart = []; renderCart();
  });

  // init
  loadSaleDropdowns();
  renderCart();
  </script>
</body>
</html>
