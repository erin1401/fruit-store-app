<!doctype html>
<html lang="id">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Penjualan â€” Juragan Buah</title><link rel="stylesheet" href="styles.css"></head>
<body>
  <div class="sidebar">
    <img src="assets/logo.png" alt="Juragan Buah" style="width:120px;display:block;margin:0 auto 10px">
    <div style="text-align:center;font-weight:700;margin-bottom:14px">Juragan Buah</div>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Barang Masuk</a>
    <a href="stock-out.html">Barang Keluar</a>
    <a href="opname.html">Stok Opname</a>
    <a href="sales.html">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html">Laporan Persediaan</a>
    <a href="report-profit.html">Laba Rugi</a>
    <hr style="border-color: rgba(255,255,255,0.06);margin-top:12px">
    <a href="users.html">Manajemen User</a>
  </div>

  <div class="main">
    <div class="topbar card" style="display:flex;justify-content:space-between;align-items:center"><h1 style="margin:0">Penjualan</h1><div id="userBox"></div></div>

    <div class="card" style="display:flex;gap:14px;margin-top:14px">
      <div style="flex:1">
        <label>Pembeli</label>
        <select id="saleBuyer"></select>
        <label>Pilih Item</label>
        <select id="saleItem"></select>
        <label>Qty</label>
        <input id="saleQty" type="number" value="1">
        <div style="margin-top:10px"><button class="btn" id="btnAddCart">Tambah ke Keranjang</button></div>
      </div>

      <div style="width:420px">
        <h4>Keranjang</h4>
        <table id="cartTable"><thead><tr><th>Item</th><th>Harga</th><th>Qty</th><th>Subtotal</th><th>Aksi</th></tr></thead><tbody></tbody></table>
        <div style="text-align:right;margin-top:10px">Total: <b id="cartTotal">Rp 0</b></div>
        <div style="text-align:right;margin-top:8px"><button class="btn" id="btnCheckout">Simpan Transaksi</button></div>
      </div>
    </div>
  </div>

  <div id="globalModal" class="modal-bg"><div id="globalModalBox" class="modal-box"></div></div>
  <div id="globalToast" class="toast"></div>
  <div id="globalFab" class="fab hidden">ï¼‹</div>

  <script src="utils.js"></script>
  <script src="data.js"></script>
  <script>
    const session = loadJSON('sessionUser', null); if(!session) location.href='login.html';
    document.getElementById('userBox').innerText = `ðŸ‘¤ ${session.name||session.username} (${session.role})`;

    let cart = [];
    function loadSaleDropdowns(){
      const items = DataStore.getItems();
      const buyers = DataStore.getBuyers();
      document.getElementById('saleItem').innerHTML = items.map(i=>`<option value="${i.id}">${i.name} (Stok:${i.stock})</option>`).join('');
      document.getElementById('saleBuyer').innerHTML = buyers.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    }

    function renderCart(){
      const tbody = document.querySelector('#cartTable tbody'); tbody.innerHTML='';
      let total=0;
      cart.forEach((c,idx)=>{
        total+=c.subtotal;
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${c.name}</td><td>${formatRupiah(c.price)}</td><td>${c.qty}</td><td>${formatRupiah(c.subtotal)}</td><td><button class="btn btn-danger" onclick="removeCart(${idx})">Hapus</button></td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('cartTotal').innerText = formatRupiah(total);
    }

    function addToCart(){
      const itemId = document.getElementById('saleItem').value;
      const qty = Number(document.getElementById('saleQty').value)||1;
      const item = DataStore.getItemById(itemId);
      if(qty>item.stock){ toast('Stok tidak mencukupi','error'); return; }
      const price = item.price;
      cart.push({ itemId, name: item.name, price, qty, subtotal: price*qty });
      renderCart();
    }
    function removeCart(i){ cart.splice(i,1); renderCart(); }

    function checkout(){
      if(cart.length===0){ toast('Keranjang kosong','warn'); return; }
      const buyerId = document.getElementById('saleBuyer').value;
      const saleItems = cart.map(c=>({ itemId: c.itemId, qty: c.qty, price: c.price }));
      try{
        DataStore.createSale({ buyerId, items: saleItems, cashier: (loadJSON('sessionUser')||{}).username || 'kasir' });
        toast('Transaksi tersimpan');
        cart=[]; renderCart(); loadSaleDropdowns();
      }catch(e){ toast(e.message,'error'); }
    }

    document.getElementById('btnAddCart').addEventListener('click', addToCart);
    document.getElementById('btnCheckout').addEventListener('click', checkout);
    showFab(()=>{ document.getElementById('saleQty').focus(); }, 'Tambah');

    loadSaleDropdowns(); renderCart();
  </script>
</body>
</html>
