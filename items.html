<!doctype html>
<html lang="id">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Master Item â€” Juragan Buah</title><link rel="stylesheet" href="styles.css"></head>
<body>
  <div class="sidebar">
    <img src="assets/logo.svg" alt="Juragan Buah" style="width:100px;display:block;margin:6px auto">
    <div class="app-name">Juragan Buah</div>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html" class="active">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Item Masuk</a>
    <a href="stock-out.html">Item Keluar</a>
    <a href="opname.html">Stok Opname</a>
    <a href="sales.html">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html">Laporan Persediaan</a>
    <a href="report-profit.html">Laba Rugi</a>
    <a href="users.html">User Management</a>
  </div>

  <div class="main">
    <div class="topbar">
      <h1>Master Item</h1>
      <div id="userBox"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <input id="searchItem" placeholder="Cari item..." style="max-width:420px">
        <div>
          <button class="btn" id="btnAddItem">+ Tambah Item</button>
        </div>
      </div>

      <table id="itemsTable" style="margin-top:12px"><thead><tr><th>Kode</th><th>Nama</th><th>Harga</th><th>HPP</th><th>Stok</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="globalModal" class="modal-bg"><div id="globalModalBox" class="modal-box"></div></div>
  <div id="globalToast" class="toast"></div>

  <script src="utils.js"></script>
  <script src="data.js"></script>
  <script>
    checkLogin(); activateSidebarLinks();

    function renderItems(){
      const list = DataStore.getItems();
      const kw = (document.getElementById('searchItem').value||'').toLowerCase();
      const tbody = document.querySelector('#itemsTable tbody'); tbody.innerHTML = '';
      list.filter(i => (i.name||'').toLowerCase().includes(kw) || (i.code||'').toLowerCase().includes(kw)).forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.code||''}</td><td>${it.name}</td><td>${formatRupiah(it.price)}</td><td>${formatRupiah(it.cost)}</td><td>${it.stock}</td><td><button class="btn" onclick="editItem('${it.id}')">Edit</button> <button class="btn btn-danger" onclick="removeItem('${it.id}')">Hapus</button></td>`;
        tbody.appendChild(tr);
      });
    }
    document.getElementById('searchItem').addEventListener('input', renderItems);

    document.getElementById('btnAddItem').addEventListener('click', ()=>{
      openModal(`<h3>Tambah Item</h3>
        <label>Kode</label><input id="mi_code">
        <label>Nama</label><input id="mi_name">
        <label>Harga jual</label><input id="mi_price" type="number" value="0">
        <label>HPP</label><input id="mi_cost" type="number" value="0">
        <label>Stok awal</label><input id="mi_stock" type="number" value="0">
        <div style="text-align:right;margin-top:12px"><button class="btn" id="saveItemBtn">Simpan</button> <button class="btn btn-danger" onclick="closeModal()">Batal</button></div>`);
      setTimeout(()=> {
        document.getElementById('saveItemBtn').onclick = ()=>{
          const code = document.getElementById('mi_code').value.trim();
          const name = document.getElementById('mi_name').value.trim();
          const price = Number(document.getElementById('mi_price').value)||0;
          const cost = Number(document.getElementById('mi_cost').value)||0;
          const stock = Number(document.getElementById('mi_stock').value)||0;
          if(!name){ toast('Nama item wajib','warn'); return; }
          DataStore.addItem({ code, name, price, cost, stock });
          toast('Item ditambahkan');
          closeModal(); renderItems();
        };
      },60);
    });

    function editItem(id){
      const it = DataStore.getItemById(id);
      openModal(`<h3>Edit Item</h3>
        <input type="hidden" id="ei_id" value="${it.id}">
        <label>Kode</label><input id="ei_code" value="${it.code||''}">
        <label>Nama</label><input id="ei_name" value="${it.name||''}">
        <label>Harga jual</label><input id="ei_price" type="number" value="${it.price||0}">
        <label>HPP</label><input id="ei_cost" type="number" value="${it.cost||0}">
        <label>Stok</label><input id="ei_stock" type="number" value="${it.stock||0}">
        <div style="text-align:right;margin-top:12px"><button class="btn" id="saveEditItem">Simpan</button> <button class="btn btn-danger" onclick="closeModal()">Batal</button></div>`);
      setTimeout(()=> {
        document.getElementById('saveEditItem').onclick = ()=>{
          const id = document.getElementById('ei_id').value;
          const patch = {
            code: document.getElementById('ei_code').value.trim(),
            name: document.getElementById('ei_name').value.trim(),
            price: Number(document.getElementById('ei_price').value)||0,
            cost: Number(document.getElementById('ei_cost').value)||0,
            stock: Number(document.getElementById('ei_stock').value)||0
          };
          DataStore.updateItem(id, patch);
          toast('Item diperbarui');
          closeModal(); renderItems();
        };
      },60);
    }

    function removeItem(id){
      if(!confirm('Hapus item?')) return;
      DataStore.deleteItem(id);
      toast('Item dihapus');
      renderItems();
    }

    renderItems();
  </script>
</body>
</html>
