<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Master Item â€” Juragan Buah</title>
  <link rel="stylesheet" href="styles.css">
  <style>.small-input{max-width:320px}</style>
</head>
<body>
  <div class="sidebar">
    <img src="assets/logo.png" alt="Juragan Buah" style="width:120px;display:block;margin:0 auto 10px">
    <div style="text-align:center;font-weight:700;margin-bottom:14px">Juragan Buah</div>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Barang Masuk</a>
    <a href="stock-out.html">Barang Keluar</a>
    <a href="opname.html">Stok Opname</a>
    <a href="sales.html">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html">Laporan Persediaan</a>
    <a href="report-profit.html">Laba Rugi</a>
    <hr style="border-color: rgba(255,255,255,0.06);margin-top:12px">
    <a href="users.html">Manajemen User</a>
  </div>

  <div class="main">
    <div class="topbar card" style="display:flex;justify-content:space-between;align-items:center">
      <h1 style="margin:0">Master Item</h1>
      <div id="userBox"></div>
    </div>

    <div class="card" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <input id="searchItems" class="small-input" placeholder="Cari nama / kode">
        </div>
        <div>
          <button class="btn" id="btnAddItem">+ Tambah Item</button>
        </div>
      </div>

      <table id="itemsTable" style="margin-top:12px">
        <thead><tr><th>Kode</th><th>Nama</th><th>Kategori</th><th>Harga</th><th>HPP</th><th>Stok</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="globalModal" class="modal-bg"><div id="globalModalBox" class="modal-box"></div></div>
  <div id="globalToast" class="toast"></div>
  <div id="globalFab" class="fab hidden">ï¼‹</div>

  <script src="utils.js"></script>
  <script src="data.js"></script>
  <script>
    const session = loadJSON('sessionUser', null); if(!session) location.href='login.html';
    document.getElementById('userBox').innerText = `ðŸ‘¤ ${session.name||session.username} (${session.role})`;

    function renderItems(){
      const list = DataStore.getItems();
      const kw = (document.getElementById('searchItems').value||'').toLowerCase();
      const tbody = document.querySelector('#itemsTable tbody'); tbody.innerHTML='';
      list.filter(it => it.name.toLowerCase().includes(kw) || it.code.toLowerCase().includes(kw)).forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.code}</td><td>${it.name}</td><td>${it.category||''}</td><td>${formatRupiah(it.price)}</td><td>${formatRupiah(it.cost)}</td><td>${it.stock}</td>
          <td><button class="btn" onclick="onEditItem('${it.id}')">Edit</button> <button class="btn btn-danger" onclick="onDeleteItem('${it.id}')">Hapus</button></td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('searchItems').addEventListener('input', renderItems);

    function openAddItemModal(){
      openModal(`<h3>Tambah Item</h3>
        <label>Kode</label><input id="m_code">
        <label>Nama</label><input id="m_name">
        <label>Kategori</label><input id="m_category">
        <label>Harga Jual</label><input id="m_price" type="number">
        <label>HPP</label><input id="m_cost" type="number">
        <label>Stok Awal</label><input id="m_stock" type="number">
        <div style="text-align:right;margin-top:12px"><button class="btn" onclick="saveModalItem()">Simpan</button> <button class="btn btn-danger" onclick="closeModal()">Batal</button></div>`);
    }
    function saveModalItem(){
      const data = { code: document.getElementById('m_code').value.trim(), name: document.getElementById('m_name').value.trim(), category: document.getElementById('m_category').value.trim(), price: Number(document.getElementById('m_price').value)||0, cost: Number(document.getElementById('m_cost').value)||0, stock: Number(document.getElementById('m_stock').value)||0 };
      try{ DataStore.addItem(data); toast('Item ditambahkan'); closeModal(); renderItems(); }catch(e){ toast(e.message,'error'); }
    }

    function onEditItem(id){
      const it = DataStore.getItemById(id);
      openModal(`<h3>Edit Item</h3><input type="hidden" id="e_id" value="${it.id}">
        <label>Kode</label><input id="e_code" value="${it.code}">
        <label>Nama</label><input id="e_name" value="${it.name}">
        <label>Kategori</label><input id="e_category" value="${it.category||''}">
        <label>Harga</label><input id="e_price" type="number" value="${it.price}">
        <label>HPP</label><input id="e_cost" type="number" value="${it.cost}">
        <label>Stok</label><input id="e_stock" type="number" value="${it.stock}">
        <div style="text-align:right;margin-top:12px"><button class="btn" onclick="saveEditItem()">Simpan</button> <button class="btn btn-danger" onclick="closeModal()">Batal</button></div>`);
    }
    function saveEditItem(){
      const id = document.getElementById('e_id').value;
      const patch = { code: document.getElementById('e_code').value.trim(), name: document.getElementById('e_name').value.trim(), category: document.getElementById('e_category').value.trim(), price: Number(document.getElementById('e_price').value)||0, cost: Number(document.getElementById('e_cost').value)||0, stock: Number(document.getElementById('e_stock').value)||0 };
      DataStore.updateItem(id, patch); toast('Item diperbarui'); closeModal(); renderItems();
    }
    function onDeleteItem(id){ if(!confirm('Hapus item?')) return; DataStore.deleteItem(id); toast('Item dihapus'); renderItems(); }

    document.getElementById('btnAddItem').addEventListener('click', openAddItemModal);
    showFab(openAddItemModal, 'Tambah Item');

    renderItems();
  </script>
</body>
</html>
