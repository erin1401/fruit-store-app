<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Manajemen User ‚Äî Juragan Buah/title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* small overrides */
    .actions { display:flex; gap:8px; }
    .small-muted { color:#666; font-size:13px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>üçè Juragan Buah</h2>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Master Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="stock-in.html">Barang Masuk</a>
    <a href="stock-out.html">Barang Keluar</a>
    <a href="opname.html">Stok Opname</a>
    <a href="sales.html">Penjualan</a>
    <a href="report-sales.html">Laporan Penjualan</a>
    <a href="report-stock.html">Laporan Persediaan</a>
    <a href="report-profit.html">Laba Rugi</a>
    <a href="users.html" style="background:rgba(255,255,255,0.35)">Manajemen User</a>
  </div>

  <div class="main">
    <h2>Manajemen User</h2>
    <p class="small-muted">Hanya admin yang dapat menambah/hapus/ganti password user.</p>

    <div style="display:flex;gap:12px;align-items:center">
      <button class="btn" onclick="openAddUser()">+ Tambah User</button>
      <button class="btn btn-secondary" onclick="seedSample()">Reset ke Sample Data</button>
      <button class="btn btn-warning" onclick="exportUsers()">Export Users (.csv)</button>
    </div>

    <table class="table" style="margin-top:12px">
      <thead><tr><th>Username</th><th>Nama</th><th>Role</th><th>Aksi</th></tr></thead>
      <tbody id="usersTable"></tbody>
    </table>
  </div>

  <!-- modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">‚úñ</span>
      <h3 id="modalTitle">Tambah User</h3>
      <input id="uid" type="hidden">
      <label>Username</label><input id="u_username" />
      <label>Nama Lengkap</label><input id="u_name" />
      <label>Password</label><input id="u_password" type="password" />
      <label>Role</label>
      <select id="u_role"><option value="admin">admin</option><option value="kasir">kasir</option></select>
      <div style="text-align:right;margin-top:12px">
        <button class="btn" onclick="saveUser()">Simpan</button>
      </div>
    </div>
  </div>

  <script src="utils.js"></script>
  <script src="data.js"></script>

  <script>
    const session = loadJSON('sessionUser', null);
    if(!session) location.href='login.html';
    if(session.role !== 'admin') {
      alert('Akses ditolak ‚Äî hanya admin.');
      location.href='dashboard.html';
    }

    function renderUsers(){
      const tbody = document.getElementById('usersTable');
      const users = DataStore.getUsers();
      tbody.innerHTML = users.map(u => `
        <tr>
          <td>${u.username}</td>
          <td>${u.name || '-'}</td>
          <td>${u.role}</td>
          <td>
            <div class="actions">
              <button class="btn" onclick="editUser('${u.id}')">Edit</button>
              <button class="btn btn-danger" onclick="deleteUserConfirm('${u.id}')">Hapus</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function openAddUser(){
      document.getElementById('modalTitle').innerText = 'Tambah User';
      ['uid','u_username','u_name','u_password'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('u_role').value = 'kasir';
      document.getElementById('modal').style.display = 'flex';
    }

    function editUser(id){
      const u = DataStore.getUsers().find(x=>x.id===id);
      if(!u) return;
      document.getElementById('modalTitle').innerText = 'Edit User';
      document.getElementById('uid').value = u.id;
      document.getElementById('u_username').value = u.username;
      document.getElementById('u_name').value = u.name;
      document.getElementById('u_password').value = '';
      document.getElementById('u_role').value = u.role;
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal(){ document.getElementById('modal').style.display = 'none'; }

    function saveUser(){
      const id = document.getElementById('uid').value;
      const username = document.getElementById('u_username').value.trim();
      const name = document.getElementById('u_name').value.trim();
      const password = document.getElementById('u_password').value;
      const role = document.getElementById('u_role').value;

      try{
        if(!id){
          DataStore.addUser({username, password: password || '123456', name, role});
          showToast('User ditambahkan','success');
        } else {
          const patch = { username, name, role };
          if(password) patch.password = password;
          DataStore.updateUser(id, patch);
          showToast('User diperbarui','success');
        }
        closeModal();
        renderUsers();
      }catch(e){
        showToast(e.message,'error');
      }
    }

    function deleteUserConfirm(id){
      if(!confirm('Hapus user?')) return;
      DataStore.deleteUser(id);
      showToast('User terhapus','success');
      renderUsers();
    }

    function seedSample(){
      if(!confirm('Reset semua data ke sample?')) return;
      DataStore.seedSampleData();
      showToast('Data sample dipulihkan','success');
      renderUsers();
    }

    function exportUsers(){
      const rows = [['username','name','role']];
      DataStore.getUsers().forEach(u => rows.push([u.username, u.name || '', u.role]));
      exportCSV('users.csv', rows);
      showToast('Export users selesai','success');
    }

    renderUsers();
  </script>
</body>
</html>

